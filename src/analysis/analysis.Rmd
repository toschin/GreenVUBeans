---
title: "Analysis of Test Results"
author: "Team GreenBeans"
date: "2023-09-08"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results = "hide",fig.show = 'hide'  )
```

```{r}
library(tidyverse)
library(car)
library(effsize)
library(xtable)
library(grid)
library(ggplot2)
library(lattice)
library(gridExtra)
theme_set(theme_gray(base_size = 18))
```

## Read data

```{r}
data <- read.csv("../../data/processed/data.csv")
# data <- read.csv("data/processed/data.csv")
data
```

## Convert columns to factor and numeric type

```{r}
data$concat <- as.factor(data$concat)
data$queue_limit <- as.factor(data$queue_limit)
data$ncores <- as.factor(data$ncores)
data$ConsumedEnergy <- as.numeric(gsub("K", "e3", data$ConsumedEnergy))


# HH:MM:SS is converted into an integer of seconds
data$Elapsed <- sapply(strsplit(data$Elapsed,":"),
  function(x) {
    x <- as.numeric(x)
    x[1]*3600+x[2]*60+x[3]
    }
)
```

## Select data of modes HPC and local

```{r}
data_hpc <- data %>%
  filter(mode == "hpc")
data_local <- data %>%
  filter(mode == "local")
```

## Test normality of Consumed Energy

### Graphical Summary

```{r}
ggplot(data_hpc, aes(x = ConsumedEnergy)) + 
  geom_histogram()
ggplot(data_local, aes(x = ConsumedEnergy)) + 
  geom_histogram()
violin_energy_hpc_local <- ggplot(data, aes(x = mode, y = ConsumedEnergy)) +
  geom_violin(trim = FALSE, alpha = 0.8) + # alpha for the opacity
  geom_boxplot(width = 0.2, fill = "white", outlier.size = 0.2) +
  stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
  labs(
    x = "mode",
    y = "Consumed Energy in Joules")
ggsave("../../plots/violin_energy_hpc_local.png", plot = violin_energy_hpc_local, width = 10, height = 6)

summary_energy_hpc_local <-  data %>%
  group_by(mode)%>%
  summarize(n=n(),
            Min. = min (ConsumedEnergy),
            Max. = max (ConsumedEnergy),
            Median = median(ConsumedEnergy),
            Mean = mean(ConsumedEnergy),
            SD = sd (ConsumedEnergy),
            CV = 100 * sd(ConsumedEnergy) / mean(ConsumedEnergy)
            )
print(xtable(summary_energy_hpc_local, type = "latex"), file = "../../tables/summary_energy_hpc_local.tex")

qqPlot(data_hpc$ConsumedEnergy)
qqPlot(data_local$ConsumedEnergy)
```

### Statistical Tests

```{r}
# HPC
shapiro.test(data_hpc$ConsumedEnergy)
ks.test(data_hpc$ConsumedEnergy, "pnorm")

# Local
shapiro.test(data_local$ConsumedEnergy)
ks.test(data_local$ConsumedEnergy, "pnorm")
```

## Test normality of Runtime

### Graphical Summary

```{r}
ggplot(data_hpc, aes(x = Elapsed)) + 
  geom_histogram()
ggplot(data_local, aes(x = Elapsed)) + 
  geom_histogram()
violin_runtime_hpc_local <- ggplot(data, aes(x = mode, y = Elapsed)) +
  geom_violin(trim = FALSE, alpha = 0.8) + # alpha for the opacity
  geom_boxplot(width = 0.2, fill = "white", outlier.size = 0.2) +
  stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
  labs(
    x = "mode",
    y = "Runtime in seconds")

ggsave("../../plots/violin_runtime_hpc_local.png", plot = violin, width = 10, height = 6)
ggsave("../../plots/violin_combined.png", plot = grid.arrange(violin_energy_hpc_local, violin_runtime_hpc_local, nrow = 2), width = 10, height = 6)
summary_runtime_hpc_local <-  data %>%
  group_by(mode)%>%
  summarize(n=n(),
            Min. = min (Elapsed),
            Max. = max (Elapsed),
            Median = median(Elapsed),
            Mean = mean(Elapsed),
            SD = sd (Elapsed),
            CV = 100 * sd(Elapsed) / mean(Elapsed)
            )
print(xtable(summary_runtime_hpc_local, type = "latex"), file = "../../tables/summary_runtime_hpc_local.tex")

qqPlot(data_hpc$Elapsed)
qqPlot(data_local$Elapsed)
```

### Statistical Tests

```{r}
# HPC
shapiro.test(data_hpc$Elapsed)
ks.test(data_hpc$Elapsed, "pnorm")

# Local
shapiro.test(data_local$Elapsed)
ks.test(data_local$Elapsed, "pnorm")
```

## Test normality of nAveVMSize

### Graphical Summary

```{r}
ggplot(data_hpc, aes(x = nAveVMSize)) + 
  geom_histogram()
ggplot(data_local, aes(x = nAveVMSize)) + 
  geom_histogram()
violin <- ggplot(data, aes(x=mode, y=nAveVMSize)) +
          geom_violin(trim=FALSE, alpha = 0.8) + # alpha for the opacity
          geom_boxplot(width=0.2, fill="white", outlier.size = 0.2) +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Violin Plot with Inner Boxplot",
          x="mode",
          y="Average Virtual Memory Size in Bytes")
ggsave("../../plots/violin_memory_hpc_local.png", plot = violin, width = 10, height = 6)

summary_memory_hpc_local <-  data %>%
  group_by(mode)%>%
  summarize(n=n(),
            Min. = min (nAveVMSize),
            Max. = max (nAveVMSize),
            Median = median(nAveVMSize),
            Mean = mean(nAveVMSize),
            SD = sd (nAveVMSize),
            CV = 100 * sd(nAveVMSize) / mean(nAveVMSize)
            )
print(xtable(summary_memory_hpc_local, type = "latex"), file = "../../tables/summary_memory_hpc_local.tex")

qqPlot(data_hpc$nAveVMSize)
qqPlot(data_local$nAveVMSize)
```

### Statistical Tests

```{r}
# HPC
shapiro.test(data_hpc$nAveVMSize)
ks.test(data_hpc$nAveVMSize, "pnorm")

# Local
shapiro.test(data_local$nAveVMSize)
ks.test(data_local$nAveVMSize, "pnorm")
```

## Mann-Whitney U Test: local vs hpc

```{r}
wilcox.test(data_local$ConsumedEnergy, data_hpc$ConsumedEnergy, alternative = "greater")
cliff.delta(data_local$ConsumedEnergy, data_hpc$ConsumedEnergy)

wilcox.test(data_local$Elapsed, data_hpc$Elapsed, alternative = "less")
cliff.delta(data_local$Elapsed, data_hpc$Elapsed)


wilcox.test(data_local$nAveVMSize, data_hpc$nAveVMSize)
cliff.delta(data_local$nAveVMSize, data_hpc$nAveVMSize)
```
```

## Factors in mode local

### Graphical Summary

```{r}
ggplot(data_local, aes(x = ncores, y = ConsumedEnergy)) + 
  facet_grid(NodeList ~ ncores, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar") 
ggplot(data_local, aes(x = ncores, y = Elapsed)) + 
  facet_grid(NodeList ~ ncores, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar")
ggplot(data_local, aes(x = ncores, y = nAveVMSize)) + 
  facet_grid(NodeList ~ ncores, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar")
ggplot(data_local, aes(x=ncores, y=ConsumedEnergy)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Violin Plot with Inner Boxplot",
          x="ncores",
          y="Consumed Energy")
ggplot(data_local, aes(x=ncores, y=Elapsed)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Violin Plot with Inner Boxplot",
          x="ncores",
          y="Runtime")
ggplot(data_local, aes(x=ncores, y=nAveVMSize)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Violin Plot with Inner Boxplot",
          x="ncores",
          y="nAveVMSize")

data_local %>%
  group_by(ncores)%>%
  summarize(n=n(),
            mean = mean(ConsumedEnergy),
            median = median(ConsumedEnergy),
            sd = sd (ConsumedEnergy),
            IQR = IQR (ConsumedEnergy),
            min = min (ConsumedEnergy),
            max = max (ConsumedEnergy)
            )

data_local %>%
  group_by(ncores)%>%
  summarize(n=n(),
            mean = mean(Elapsed),
            median = median(Elapsed),
            sd = sd (Elapsed),
            IQR = IQR (Elapsed),
            min = min (Elapsed),
            max = max (Elapsed)
            )

data_local %>%
  group_by(ncores)%>%
  summarize(n=n(),
            mean = mean(nAveVMSize),
            median = median(nAveVMSize),
            sd = sd (nAveVMSize),
            IQR = IQR (nAveVMSize),
            min = min (nAveVMSize),
            max = max (nAveVMSize)
            )
interaction.plot(data_local$ncores, data_local$NodeList, data_local$ConsumedEnergy)
interaction.plot(data_local$ncores, data_local$NodeList, data_local$Elapsed)
interaction.plot(data_local$ncores, data_local$NodeList, data_local$nAveVMSize)
```

### Statistical Tests

#### Consumed Energy

```{r}
# Additive Model without Interaction
lm_local <- lm(ConsumedEnergy ~ ncores + NodeList, data = data_local)
anova(lm_local)
summary(lm_local)
qqPlot(residuals(lm_local))
#friedman.test(data_local$ConsumedEnergy, data_local$ncores, data_local$NodeList)
```

```{r}
data_local_gl2_gl5 <- data_local %>%
  filter((NodeList == 'gl5' & ncores != 16 &ncores != 32) | (NodeList == 'gl2'))
data_local_gl5_gl6 <- data_local %>%
  filter((NodeList == 'gl5' & ncores != 2 &ncores != 4) | (NodeList == 'gl6'))
lm_gl2_gl5 <- lm(ConsumedEnergy ~ ncores + NodeList, data=data_local_gl2_gl5) #ncores and NodeList not significant
lm_gl2_gl5_2 <-lm(ConsumedEnergy ~ NodeList, data=data_local_gl2_gl5) #NodeList not significant
lm_gl5_gl6 <- lm(ConsumedEnergy ~ ncores + NodeList, data=data_local_gl5_gl6) #NodeList not significant
lm_gl5_gl6_2 <- lm(ConsumedEnergy ~ ncores, data=data_local_gl5_gl6)
anova(lm_gl2_gl5)
anova(lm_gl2_gl5_2)
anova(lm_gl5_gl6)
anova(lm_gl5_gl6_2)
qqPlot(residuals(lm_gl2_gl5))
qqPlot(residuals(lm_gl5_gl6))
qqPlot(residuals(lm_gl5_gl6_2))
```

#### Runtime

```{r}
# Additive Model without Interaction
lm_local <- lm(Elapsed ~ ncores + NodeList, data = data_local)
anova(lm_local)
summary(lm_local)
qqPlot(residuals(lm_local))
```

```{r}
lm_gl2_gl5 <- lm(Elapsed ~ ncores + NodeList, data=data_local_gl2_gl5)
lm_gl2_gl5_2 <-lm(Elapsed ~ ncores, data=data_local_gl2_gl5) 
lm_gl5_gl6 <- lm(Elapsed ~ ncores + NodeList, data=data_local_gl5_gl6)
lm_gl5_gl6_2 <- lm(Elapsed ~ ncores, data=data_local_gl5_gl6)
anova(lm_gl2_gl5)
anova(lm_gl2_gl5_2)
anova(lm_gl5_gl6)
anova(lm_gl5_gl6_2)
qqPlot(residuals(lm_gl2_gl5))
qqPlot(residuals(lm_gl2_gl5_2))
qqPlot(residuals(lm_gl5_gl6))
qqPlot(residuals(lm_gl5_gl6_2))
```

#### nAveVMSize

```{r}
# Additive Model without Interaction
lm_local <- lm(nAveVMSize ~ ncores + NodeList, data = data_local)
anova(lm_local)
summary(lm_local)
qqPlot(residuals(lm_local))
```

## Factors in mode HPC

### Graphical Summary

```{r}
ggplot(data_hpc, aes(x = queue_limit, y = ConsumedEnergy)) + 
  facet_grid(concat ~ queue_limit, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar") 
ggplot(data_hpc, aes(x = queue_limit, y = Elapsed)) + 
  facet_grid(concat ~ queue_limit, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar") 
ggplot(data_hpc, aes(x = queue_limit, y = nAveVMSize)) + 
  facet_grid(concat ~ queue_limit, labeller=label_both, scales='fixed') +
  stat_summary(fun = mean, geom = "bar") 
ggplot(data_hpc, aes(x=queue_limit, y=ConsumedEnergy)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Queue Limit",
          y="Consumed Energy")
ggplot(data_hpc, aes(x=concat, y=ConsumedEnergy)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Concat",
          y="Consumed Energy")
ggplot(data_hpc, aes(x=queue_limit, y=Elapsed)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Queue Limit",
          y="Runtime")
ggplot(data_hpc, aes(x=concat, y=Elapsed)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Concat",
          y="Runtime")
ggplot(data_hpc, aes(x=queue_limit, y=nAveVMSize)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Queue Limit",
          y="nAveVMSize")
ggplot(data_hpc, aes(x=concat, y=nAveVMSize)) +
          geom_boxplot() +
          stat_summary(fun = mean, geom = "point", shape = 1, size = 2) +
          labs(title="Boxplot",
          x="Concat",
          y="nAveVMSize")

data_hpc %>%
  group_by(queue_limit)%>%
  summarize(n=n(),
            mean = mean(ConsumedEnergy),
            median = median(ConsumedEnergy),
            sd = sd (ConsumedEnergy),
            IQR = IQR (ConsumedEnergy),
            min = min (ConsumedEnergy),
            max = max (ConsumedEnergy)
            )

data_hpc %>%
  group_by(queue_limit)%>%
  summarize(n=n(),
            mean = mean(Elapsed),
            median = median(Elapsed),
            sd = sd (Elapsed),
            IQR = IQR (Elapsed),
            min = min (Elapsed),
            max = max (Elapsed)
            )

data_hpc %>%
  group_by(queue_limit)%>%
  summarize(n=n(),
            mean = mean(nAveVMSize),
            median = median(nAveVMSize),
            sd = sd (nAveVMSize),
            IQR = IQR (nAveVMSize),
            min = min (nAveVMSize),
            max = max (nAveVMSize)
            )

interaction.plot(data_hpc$queue_limit, data_hpc$concat, data_hpc$ConsumedEnergy)
interaction.plot(data_hpc$concat, data_hpc$queue_limit, data_hpc$ConsumedEnergy)
interaction.plot(data_hpc$queue_limit, data_hpc$concat, data_hpc$Elapsed)
interaction.plot(data_hpc$concat, data_hpc$queue_limit, data_hpc$Elapsed)
interaction.plot(data_hpc$queue_limit, data_hpc$concat, data_hpc$nAveVMSize)
interaction.plot(data_hpc$concat, data_hpc$queue_limit, data_hpc$nAveVMSize)
```

### Statistical Tests

#### Consumed Energy

```{r}
# Additive Model without Interaction
lm_hpc <- lm(ConsumedEnergy ~ queue_limit + concat, data = data_hpc)
anova(lm_hpc)
summary(lm_hpc)
qqPlot(residuals(lm_hpc))
```

```{r}
lm_hpc2 <- lm(ConsumedEnergy ~ concat, data = data_hpc)
anova(lm_hpc2)
summary(lm_hpc2)
qqPlot(residuals(lm_hpc2))
```

```{r}
friedman.test(formula = ConsumedEnergy ~ queue_limit | concat, data = data_hpc)
```

#### Runtime

```{r}
# Additive Model without Interaction
lm_hpc_elapsed <- lm(Elapsed ~ queue_limit + concat, data = data_hpc)
anova(lm_hpc_elapsed)
qqPlot(residuals(lm_hpc_elapsed))
```

```{r}
lm_hpc_elapsed_2 <- lm(Elapsed ~ concat, data = data_hpc)
anova(lm_hpc_elapsed_2)
qqPlot(residuals(lm_hpc_elapsed_2)) # not normal
```

#### nAveVMSize

```{r}
# Additive Model without Interaction
lm_hpc_mem <- lm(nAveVMSize ~ queue_limit + concat, data = data_hpc)
anova(lm_hpc_mem)
qqPlot(residuals(lm_hpc_mem))
```

```{r}
# Additive Model without Interaction
lm_hpc_mem_2 <- lm(nAveVMSize ~ concat, data = data_hpc)
anova(lm_hpc_mem_2)
summary(lm_hpc_mem_2)
qqPlot(residuals(lm_hpc_mem_2))
```
